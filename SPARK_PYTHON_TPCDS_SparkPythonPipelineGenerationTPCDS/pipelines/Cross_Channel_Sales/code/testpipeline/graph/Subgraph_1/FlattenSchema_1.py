from pyspark.sql import *
from pyspark.sql.functions import *
from pyspark.sql.types import *
from prophecy.utils import *
from prophecy.libs import typed_lit
from .config import *
from testpipeline.udfs.UDFs import *

def FlattenSchema_1(spark: SparkSession, in0: DataFrame) -> DataFrame:
    flt_col = in0\
        .withColumn("ALL_STORE_SALES_PRICES", explode_outer("ALL_STORE_SALES_PRICES"))\
        .withColumn("ALL_WEB_SALES_PRICES", explode_outer("ALL_WEB_SALES_PRICES"))\
        .columns
    selectCols = [col("STORE_SALES_PRICES") if "STORE_SALES_PRICES" in flt_col else col("ALL_STORE_SALES_PRICES")\
                    .alias("STORE_SALES_PRICES"),                   col("WEB_SALES_PRICES") if "WEB_SALES_PRICES" in flt_col else col("ALL_WEB_SALES_PRICES")\
                    .alias("WEB_SALES_PRICES"),                   col("I_BRAND") if "I_BRAND" in flt_col else col("I_BRAND"),                   col("I_CLASS") if "I_CLASS" in flt_col else col("I_CLASS"),                   col("I_CATEGORY") if "I_CATEGORY" in flt_col else col("I_CATEGORY"),                   col("CS_SOLD_DATE_SK") if "CS_SOLD_DATE_SK" in flt_col else col("CS_SOLD_DATE_SK"),                   col("CS_ITEM_SK") if "CS_ITEM_SK" in flt_col else col("CS_ITEM_SK"),                   col("CS_QUANTITY") if "CS_QUANTITY" in flt_col else col("CS_QUANTITY"),                   col("CS_LIST_PRICE") if "CS_LIST_PRICE" in flt_col else col("CS_LIST_PRICE"),                   col("SS_SOLD_DATE_SK") if "SS_SOLD_DATE_SK" in flt_col else col("SS_SOLD_DATE_SK"),                   col("SS_ITEM_SK") if "SS_ITEM_SK" in flt_col else col("SS_ITEM_SK"),                   col("SS_QUANTITY") if "SS_QUANTITY" in flt_col else col("SS_QUANTITY"),                   col("SS_LIST_PRICE") if "SS_LIST_PRICE" in flt_col else col("SS_LIST_PRICE"),                   col("WS_SOLD_DATE_SK") if "WS_SOLD_DATE_SK" in flt_col else col("WS_SOLD_DATE_SK"),                   col("WS_ITEM_SK") if "WS_ITEM_SK" in flt_col else col("WS_ITEM_SK"),                   col("WS_QUANTITY") if "WS_QUANTITY" in flt_col else col("WS_QUANTITY"),                   col("WS_LIST_PRICE") if "WS_LIST_PRICE" in flt_col else col("WS_LIST_PRICE"),                   col("I_CLASS_ID") if "I_CLASS_ID" in flt_col else col("I_CLASS_ID"),                   col("CS_BILL_CUSTOMER_SK") if "CS_BILL_CUSTOMER_SK" in flt_col else col("CS_BILL_CUSTOMER_SK"),                   col("CS_SHIP_DATE_SK") if "CS_SHIP_DATE_SK" in flt_col else col("CS_SHIP_DATE_SK"),                   col("CS_SHIP_CDEMO_SK") if "CS_SHIP_CDEMO_SK" in flt_col else col("CS_SHIP_CDEMO_SK"),                   col("CS_SHIP_CUSTOMER_SK") if "CS_SHIP_CUSTOMER_SK" in flt_col else col("CS_SHIP_CUSTOMER_SK"),                   col("SS_HDEMO_SK") if "SS_HDEMO_SK" in flt_col else col("SS_HDEMO_SK"),                   col("SS_CDEMO_SK") if "SS_CDEMO_SK" in flt_col else col("SS_CDEMO_SK"),                   col("SS_ADDR_SK") if "SS_ADDR_SK" in flt_col else col("SS_ADDR_SK"),                   col("SS_STORE_SK") if "SS_STORE_SK" in flt_col else col("SS_STORE_SK"),                   col("SS_TICKET_NUMBER") if "SS_TICKET_NUMBER" in flt_col else col("SS_TICKET_NUMBER"),                   col("SS_SALES_PRICE") if "SS_SALES_PRICE" in flt_col else col("SS_SALES_PRICE"),                   col("SS_EXT_DISCOUNT_AMT") if "SS_EXT_DISCOUNT_AMT" in flt_col else col("SS_EXT_DISCOUNT_AMT"),                   col("SS_EXT_SALES_PRICE") if "SS_EXT_SALES_PRICE" in flt_col else col("SS_EXT_SALES_PRICE"),                   col("SS_EXT_WHOLESALE_COST") if "SS_EXT_WHOLESALE_COST" in flt_col else col("SS_EXT_WHOLESALE_COST"),                   col("SS_EXT_TAX") if "SS_EXT_TAX" in flt_col else col("SS_EXT_TAX"),                   col("WS_BILL_HDEMO_SK") if "WS_BILL_HDEMO_SK" in flt_col else col("WS_BILL_HDEMO_SK"),                   col("WS_BILL_ADDR_SK") if "WS_BILL_ADDR_SK" in flt_col else col("WS_BILL_ADDR_SK"),                   col("WS_EXT_WHOLESALE_COST") if "WS_EXT_WHOLESALE_COST" in flt_col else col("WS_EXT_WHOLESALE_COST"),                   col("WS_EXT_LIST_PRICE") if "WS_EXT_LIST_PRICE" in flt_col else col("WS_EXT_LIST_PRICE"),                   col("WS_EXT_TAX") if "WS_EXT_TAX" in flt_col else col("WS_EXT_TAX"),                   col("WS_COUPON_AMT") if "WS_COUPON_AMT" in flt_col else col("WS_COUPON_AMT"),                   col("WS_EXT_SHIP_COST") if "WS_EXT_SHIP_COST" in flt_col else col("WS_EXT_SHIP_COST"),                   col("WS_NET_PAID") if "WS_NET_PAID" in flt_col else col("WS_NET_PAID")]

    return in0\
        .withColumn("ALL_STORE_SALES_PRICES", explode_outer("ALL_STORE_SALES_PRICES"))\
        .withColumn("ALL_WEB_SALES_PRICES", explode_outer("ALL_WEB_SALES_PRICES"))\
        .select(*selectCols)
